local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

local cube = ReplicatedStorage.Cube
local cube_cache = require(ReplicatedStorage.modules.cube_cache)
local cube_in_hitbox = require(ReplicatedStorage.modules.cube_in_hitbox)
local debug_print = require(script.Parent.modules.debug_print)
local get_player_position = require(ReplicatedStorage.modules.get_player_position)
local player_range_server = require(ServerScriptService.modules.player_range_server)
local snap_coordinate = require(ReplicatedStorage.modules.snap_coordinate)
local play_sound_excluding = require(ServerScriptService.modules.play_sound_excluding)

local function verify_coordinate(coordinate: number): boolean
	return coordinate == snap_coordinate(coordinate)
end

local function verify_position(position: Vector3): boolean
	return (
		    verify_coordinate(position.X)
		and verify_coordinate(position.Y)
		and verify_coordinate(position.Z)
	)
end

local function on_invoke(player: Player, cube_position: unknown): boolean
	if typeof(cube_position) ~= "Vector3" then
		debug_print("Invalid arguments.")
		return false
	end

	local player_position = get_player_position(player)
	if player_position == nil then
		debug_print("Player has no position.")
		return false
	end

	local distance = (cube_position - player_position).Magnitude
	if distance > player_range_server then
		debug_print("Too far.")
		return false
	end

	if not verify_position(cube_position) then
		debug_print("Invalid position.")
		return false
	end

	local occupied_cube = cube_cache[cube_position]
	if occupied_cube then
		debug_print("Occupied by cube.")
		return false
	end

	local occupied_player = cube_in_hitbox(cube_position)
	if occupied_player then
		debug_print("Occupied by player.")
		return false
	end

	cube_cache[cube_position] = true

	local clone = cube:Clone()
	clone.Position = cube_position
	clone.Parent = workspace
	play_sound_excluding(player, "cube_place", cube_position)

	return true
end

ReplicatedStorage.remotes.place_cube.OnServerInvoke = on_invoke